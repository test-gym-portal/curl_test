name: Run Task Spec

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

# PR コメントを作成するために必要な権限を明示
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  run-spec:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract task number from PR title
        id: extract_task
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # [task_1] のような形式から task_1 を抽出
          TASK=$(echo "$PR_TITLE" | grep -oP '(?<=\[)task_\d+(?=\])' || echo "")

          if [ -z "$TASK" ]; then
            echo "::error::PRタイトルに [task_X] の形式が見つかりません"
            echo "::error::例: [task_1] タスク1の実装"
            exit 1
          fi

          echo "task=$TASK" >> $GITHUB_OUTPUT
          echo "Detected task: $TASK"

      - name: Check if spec file exists
        id: check_spec
        run: |
          TASK="${{ steps.extract_task.outputs.task }}"
          # サブディレクトリも含めて task_X*_spec.rb を検索
          SPEC_FILES=$(find spec -type f -name "${TASK}*_spec.rb")

          if [ -z "$SPEC_FILES" ]; then
            echo "::error::Specファイルが見つかりません: ${TASK}*_spec.rb"
            echo "::error::利用可能なspecファイル:"
            find spec -type f -name "*_spec.rb" || echo "specファイルが存在しません"
            exit 1
          fi

          echo "spec_files=$SPEC_FILES" >> $GITHUB_OUTPUT
          echo "::notice::実行するspecファイル:"
          echo "$SPEC_FILES"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.5"
          bundler-cache: true

      - name: Setup Database
        run: |
          bundle exec rails db:create RAILS_ENV=test
          bundle exec rails db:schema:load RAILS_ENV=test
        env:
          RAILS_ENV: test

      - name: Run specific spec
        run: |
          echo "======================================"
          echo "実行するspec:"
          echo "${{ steps.check_spec.outputs.spec_files }}"
          echo "======================================"
          # 複数ファイルを一括で実行
          bundle exec rspec ${{ steps.check_spec.outputs.spec_files }} --format documentation
        env:
          RAILS_ENV: test

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ `${{ steps.check_spec.outputs.spec_files }}` のテストが成功しました！'
            })

      - name: Comment on PR failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ `${{ steps.check_spec.outputs.spec_files }}` のテストが失敗しました。詳細はActionsログを確認してください。'
            })
